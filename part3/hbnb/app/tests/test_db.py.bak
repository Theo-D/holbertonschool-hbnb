#!/usr/bin/env python3
# scripts/test_db.py

from datetime import date, timedelta
from app import create_app
from app.database import db

# import all your models so SQLAlchemy registers them
from app.models.user    import User
from app.models.host    import Host
from app.models.place   import Place
from app.models.amenity import Amenity
from app.models.booking import Booking
from app.models.review  import Review

def main():
    app = create_app()
    with app.app_context():
        # reset schema
        db.drop_all()
        db.create_all()
        print("Created tables:", list(db.metadata.tables.keys()))

        # 1. User
        alice = User("Alice", "Liddell", "alice@example.com", "secret123")
        db.session.add(alice)

        # 2. Host
        bob = Host("Bob Builder", "bob@builder.com", "+123456789")
        db.session.add(bob)
        db.session.flush()  # get bob.id

        # 3. Place
        cottage = Place(
            title="Cozy Cottage",
            price_per_night=75.0,
            host_id=bob.id,
            description="Tiny woodland retreat"
        )
        db.session.add(cottage)

        # 4. Amenities
        wifi   = Amenity("Wi-Fi", "Wireless internet")
        coffee = Amenity("Coffee maker", "Pour-over drip coffee")
        db.session.add_all([wifi, coffee])
        db.session.flush()

        # 5. Link amenities
        cottage.amenities.extend([wifi, coffee])

        # 6. Booking
        checkin  = date.today()
        checkout = checkin + timedelta(days=3)
        booking1 = Booking(
            user_id=alice.id,
            place_id=cottage.id,
            start_date=checkin,
            end_date=checkout
        )
        db.session.add(booking1)

        # 7. Review
        review1 = Review(
            user_id=alice.id,
            place_id=cottage.id,
            rating=5,
            comment="Absolutely lovely!"
        )
        db.session.add(review1)

        # commit and verify
        db.session.commit()

        print("Bob’s places:", bob.places)
        print("Cottage’s host:", cottage.host)
        print("Alice’s bookings:", alice.bookings)
        print("Alice’s reviews:", alice.reviews)

if __name__ == "__main__":
    main()
